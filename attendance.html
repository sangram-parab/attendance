<script>
  // parse URL params
  const params = new URLSearchParams(window.location.search);
  const subject = params.get('sub') || 'Unknown Subject';
  const teacher = params.get('teacher') || 'Unknown Teacher';

  document.getElementById('title').innerText = `${subject} â€” Attendance`;
  document.getElementById('meta').innerText = `Subject: ${subject}  |  Teacher: ${teacher}`;

  const listWrap = document.getElementById('listWrap');
  const rollInput = document.getElementById('rollInput');
  const nameInput = document.getElementById('nameInput');
  const addBtn = document.getElementById('addBtn');

  let students = []; // full attendance entries

  function renderList(){
    if(students.length === 0){
      listWrap.innerHTML = '<div class="empty">No students added. Add a student to start marking attendance.</div>';
      return;
    }
    let html = '<table><thead><tr><th>Roll</th><th>Name</th><th>Status</th><th>Action</th></tr></thead><tbody>';
    students.forEach((s, idx)=>{
      html += `<tr>
        <td>${escapeHtml(s.roll)}</td>
        <td>${escapeHtml(s.name)}</td>
        <td>${s.status}</td>
        <td>
          <button onclick="toggle(${idx})">Toggle</button>
          <button onclick="remove(${idx})" style="margin-left:8px;color:#c62828">Remove</button>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    listWrap.innerHTML = html;
  }

  function escapeHtml(text){ return String(text).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

  addBtn.addEventListener('click', ()=>{
    const roll = (rollInput.value||'').trim();
    const name = (nameInput.value||'').trim();
    if(!roll || !name) return alert('Enter roll and name');

    const today = new Date().toLocaleDateString('en-IN');

    students.push({
      roll,
      name,
      subject,
      teacher,
      date: today,
      status: "Present"
    });

    rollInput.value='';
    nameInput.value='';
    renderList();
  });

  window.toggle = function(idx){
    students[idx].status = (students[idx].status === "Present") ? "Absent" : "Present";
    renderList();
  }

  window.remove = function(idx){
    students.splice(idx,1);
    renderList();
  }

  const storageKey = `attendance::${subject}::${teacher}`;

  document.getElementById('saveLocal').addEventListener('click', ()=>{
    localStorage.setItem(storageKey, JSON.stringify(students));
    alert('Saved to localStorage.');
  });

  document.getElementById('clearAll').addEventListener('click', ()=>{
    if(!confirm('Clear all student records for this session?')) return;
    students = [];
    localStorage.removeItem(storageKey);
    renderList();
  });

  (function(){
    const raw = localStorage.getItem(storageKey);
    if(raw){
      try{ students = JSON.parse(raw) || []; }catch(e){ students = []; }
    }
    renderList();
  })();
</script>
